<!doctype html>
<html>
<head>
    <title>Socket.IO chat</title>
    <link href='https://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>

<div class='container'>
    <h1>Messenger App</h1>
    <div id="rooms" class="chatbox__rooms-list rooms-list">
        <h1>Rooms</h1>
    </div>
    <div class="chatbox">
        <div id="users" class="chatbox__user-list">
            <h1>Online</h1>
        </div>
        <div class="chatbox__messages">
            <div id="messages" class="chatbox__messages__user-message"></div>
        </div>
        <form id="formMessage">
            <input id="m" type="text" placeholder="Type Message">
        </form>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
    (function ($) {
        const cache = {
            document: $(document),
            rooms: $('#rooms'),
            users: $('#users'),
            inputMessage: $("#m"),
            messages: $("#messages")
        };

        const socket = io();
        var username;

        if (typeof(Storage) !== undefined) {
            username = localStorage.getItem('username');
            console.log(`Username from localStorage is ${username}`)
        }

        while (username === undefined || username === null || username.trim() === '') {
            username = prompt("Your username:");

            if (typeof(Storage) !== undefined) {
                localStorage.setItem('username', username)
            }
        }

        socket.emit('chat.join', username);

        socket.on('rooms.getList', (rooms) => {
            for (let room of rooms) {
                cache.rooms.append(`<div data-room="${room}" class="chat-room">${room}</div>`)
            }
        });

        socket.on('rooms.getUsers', (user) => {
            if (user.username !== username) {
                cache.users.append(`<div data-user="${user.username}" class="chat-room">${user.username} / ${user.status}</div>`)
            }
        });

        socket.on('rooms.getMessages', messages => {
            if (!Array.isArray(messages)) messages = [messages];

            for (let message of messages) {
                cache.messages.append(`
                    <div class="${message.username === username ? 'float-right' : ''}">
                        <p class="name">
                            ${message.username === username ? 'Me, Myself and I' : message.username}
                        </p>
                        <br/>
                        <p class="message">${message.message}</p>
                    </div>
                `);
            }
        });

        socket.on('chat.disconnect', (json) => {
            const data = JSON.parse(json);
            $users.find(`.chatbox__user--active[data-username="${data.username}"]`).remove();
        });

        cache.document.on('click', '#rooms > .chat-room', (e) => {
            e.preventDefault();

            cache.messages.empty();
            cache.users.empty();

            socket.emit('rooms.join', $(e.target).data('room'));
        });

        cache.document.on('submit', '#formMessage', e => {
            e.preventDefault();

            socket.emit('rooms.postMessage', cache.inputMessage.val());
            cache.inputMessage.val('');
        });

    })(jQuery);
</script>
</body>
</html>